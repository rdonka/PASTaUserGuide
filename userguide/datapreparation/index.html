<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Data Preparation - PASTa</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../css/brands.min.css" rel="stylesheet">
        <link href="../../css/solid.min.css" rel="stylesheet">
        <link href="../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">PASTa</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="nav-item">
                                <a href="../../gettingstarted/" class="nav-link">Getting Started</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">User Guide</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../userguide/" class="dropdown-item">User Guide</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active" aria-current="page">Data Preparation</a>
</li>
                                    
<li>
    <a href="../signalprocessing/" class="dropdown-item">Signal Processing</a>
</li>
                                    
<li>
    <a href="../transientanalysis/" class="dropdown-item">Transient Analysis</a>
</li>
                                    
<li>
    <a href="../plotdata/" class="dropdown-item">Data Visualization</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item">
                                <a href="../../functiondocumentation/" class="nav-link">Function Documentation</a>
                            </li>
                            <li class="nav-item">
                                <a href="../../exampleanalyses/" class="nav-link">Example Analyses</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">About</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../about/pastateam/" class="dropdown-item">PASTa Team</a>
</li>
                                    
<li>
    <a href="../../about/releasenotes/" class="dropdown-item">Version Release Notes</a>
</li>
                                    
<li>
    <a href="../../about/citepasta/" class="dropdown-item">How to Cite PASTa</a>
</li>
                                    
<li>
    <a href="../../about/license/" class="dropdown-item">License</a>
</li>
                                    
<li>
    <a href="../../contactus/" class="dropdown-item">Contact Us</a>
</li>
                                    
<li>
    <a href="../../references.md" class="dropdown-item">References</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item">
                                <a href="../../learningresources/" class="nav-link">Learning Resources</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../userguide/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../signalprocessing/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#data-preparation" class="nav-link">Data Preparation</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#data-organization" class="nav-link">Data Organization</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#prepare-matlab-for-analysis" class="nav-link">Prepare MATLAB for analysis</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#extract-fiber-photometry-data" class="nav-link">Extract fiber photometry data</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#load-fiber-photometry-data" class="nav-link">Load Fiber Photometry Data</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="data-preparation">Data Preparation</h1>
<p>The first stage in the PASTa Protocol the organization, extraction, and loading of fiber photometry data and associated metadata into MATLAB prior to signal processing and analysis.</p>
<p>To streamline the analysis workflow, PASTa recommends a standardized data structure that facilitates compatibility and minimizes user error. Organizing data using the subject and file keys allows users to easily merge photometry data with experimental variables across multiple sessions, while reducing manual errors that can occur from repeated copying and pasting. This metadata management approach ensures consistent handling of subject identifiers and experimental conditions, which is essential for batch processing and reproducible analysis. </p>
<p>To import fiber photometry data into MATLAB, PASTa includes built-in functions to extract data collected with TDT systems or data collected with other systems via a generic csv format option. Pre-extracting photometry signals into individual MATLAB structures greatly reduces processing time across multiple analysis sessions, as the raw data extraction from TDT data blocks or the generic CSV data block format is often the most computationally-intensive step in the workflow.</p>
<p>Preparing and organizing data in this format ahead of analysis ensures smooth integration with PASTa’s functionality and improves overall analysis workflow efficiency. However, if neither extraction option is compatible with user data, users can adapt the existing extraction functions or create their own to accommodate other file structures and import data into MATLAB. The signal processing and transient detection functions are written to be flexible to alternative data structure organizations, providing the required fields are available in the primary data structure.</p>
<h2 id="data-organization">Data Organization</h2>
<p>To accommodate a variety of file organization structures, users first create two csv files containing the information necessary to access raw photometry data and the relevant experimental metadata for each subject and recording session. MATLAB can access raw data folders stored either locally or in a cloud-based storage app like Box or Dropbox.</p>
<h3 id="prepare-folder-structure">Prepare Folder Structure</h3>
<p>While the functions included in PASTa are written to be flexible and usable with differing data organization practices, we recommend users organize the data for each analysis in a parent folder with subfolders for Raw Data, Extracted Data, Analysis, and Figures. </p>
<p>Create the project parent folder with the subfolders <em>"Raw Data"</em>, <em>"Extracted Data"</em>, <em>"Analysis"</em>, and <em>"Figures"</em>.</p>
<p>The “Raw Data” folder should include subfolders containing the individual fiber photometry session blocks. PASTa currently includes two options for fiber photometry data: 1) Synapse (TDT) Format, and 2) CSV Format.</p>
<p>If your data doesn't match the available load options, please feel free to reach out!</p>
<h4 id="option-1-synapse-tdt-format">Option 1: Synapse (TDT) Format</h4>
<p>Fiber photometry data collected through the software <em>Synapse</em> (Tucker Davis Technologies) is stored in <strong>tanks</strong> and <strong>blocks</strong>. <strong>Tanks</strong> are parent folders created by Synapse for each experiment. <strong>Blocks</strong> are individual folders for each session containing the actual output data. Stored data cannot be accessed directly via the folder, but rather must be extracted via MATLAB.</p>
<p>By default, the tank path is: <em>C:\TDT\Synapse\Tanks</em>. Synapse recognizes experiments and subjects as key categories of information that play a special role in managing data storage and retrieval. Thus, when running the session, it is critical to ensure the correct Experiment profile is selected, and the correct Subject identifier is input for each session. By default, Synapse names data tanks automatically based on experiment name and the start time of the first recording (e.g., {ExperimentName}-{yymmdd}-{hhmmss}). Blocks of data are named based on subject (e.g., {SubjectName}-{yymmdd}-{hhmmss}) for each recording session and the start time.</p>
<p>Synapse will save a new Tank for every day unless you change the default setting. Click <em>Menu</em> at the top of the bar, then Preferences. Under the <em>Data Saving</em> tab, make sure "New Tank Each Day" is unchecked.
<img alt="png" src="../../img/datapreparation_1_SynapseDataSaving.png" />
If data are collected with Synapse (Tucker Davis Technologies), raw block folders can be placed directly in the <em>Raw Data</em> folder. Copy the data blocks output by Synapse for each session into <em>Raw Data</em>. If blocks are nested in tanks, we recommend to unnest the blocks for ease of file key creation.</p>
<h4 id="option-2-csv-format">Option 2: CSV Format</h4>
<p>If data are collected with other systems (e.g., Neurophotometics, Doric), users must first format the data files into CSV files.</p>
<p>For each individual recording session, create a folder. The folder name should be unique and include at a minimum the subject ID and recording date (e.g., “Subject001_04032025”). </p>
<p>Add separate CSV files with the session recording parameters (“recordingparams.csv”), streams (“streams.csv”), and optionally any desired event epochs (“epocs.csv”).</p>
<p><strong>REQUIRED FILES:</strong></p>
<ul>
<li>
<p><strong>recordingparams.csv:</strong> A csv file containing fiber photometry recording parameters. Each parameter should be a separate column, with the name of the parameter in the first row and the value in the second row. At a minimum, this must include ‘fs’, containing the sampling rate the data streams were recorded at.</p>
</li>
<li>
<p><strong>sig.csv:</strong> A csv file containing the signal stream values. Each value should be in a separate row with the first value starting in row 1.</p>
</li>
<li>
<p><strong>baq.csv:</strong> A csv file containing the background stream values. Each value should be in a separate row with the first value starting in row 1.</p>
</li>
</ul>
<p><strong>OPTIONAL FILES:</strong> </p>
<ul>
<li><strong>Event epoch files:</strong> Individual csv files containing any desired event or behavioral epochs to be included in the analysis. Each epoch type should be saved as a separate csv file (e.g., ‘epoc_injt.csv’). Each epoch value should be in a separate row with the first value starting in row 1.</li>
</ul>
<p><em>Note: Epochs must be specified as sample number relative to the recorded data streams. Epochs specified as time values must be converted to sample indexes prior to extracting the data.</em></p>
<ul>
<li><strong>Other relevant data streams:</strong> Additional csv files with other relevant data streams, such as time indexes of each sample.</li>
</ul>
<p>After prepared individual session folders are created, copy the blocks to the <em>Raw Data</em> folder in the project parent folder.</p>
<h3 id="create-the-subject-and-file-keys">Create the Subject and File Keys</h3>
<p>To accomodate a variety of file organization structures, users can first create two csv files containing the information necessary to access raw data, and experimental metadata to match to raw photometry data. MATLAB can access raw data folders stored either locally or in a cloud-based storage app like Box or Dropbox. </p>
<p>To faciliate analysis, users can create two keys as csv files: a subject key and a file key. In the PASTa protocol, these files will be knit together to pair subject specific information with each individual session of data, preventing the need for manual repeated entry of subject specific information and reduce the time burden of properly maintaining and including experimental metadata factors like subject traits, treatments, and experimental equipment.</p>
<p>The <strong>subject key</strong> is a csv file with the experimentally relevant subject metadata that is consistent for a subject across all recording sessions (e.g., sex, DOB, implant location, sensor, experimental group, etc). </p>
<p>The <strong>file key</strong> is a csv file that lists the names of folders containing data files and the file paths to locate raw data and store extracted data. In the PASTa protocol, the subject key information will be joined to the individual session data to pair subject specific information with each individual recording. The subject key file prevents the need for manual repeated entry of subject specific information, a process that is error-prone. Further, a subject key file reduces the time burden of properly maintaining and including factors like subject traits, treatments, and experimental equipment. At minimum, the subject key must contain the field <em>“SubjectID”</em>. Any additional fields can be added as columns in the csv file, and fields can contain any format of data (numeric, string, etc).</p>
<h4 id="create-and-save-the-subject-key">Create and Save the Subject Key</h4>
<p>The subject key should contain information about each subject that is constant and unchanging such as SubjectID, sex, date of birth, fiber location, sensor, experimental group, and any other user specificed information. </p>
<p><strong>For example:</strong></p>
<p><img alt="png" src="../../img/datapreparation_2_SubjectKeyExample.png" /></p>
<p><strong>1.</strong> Create a .csv file with a column labeled “SubjectID”. Enter the unique SubjectID for each subject included in the experiment.</p>
<p><strong>2.</strong> Optional but recommended: Add additional columns for relevant metadata, such as <em>“Sex”</em>, <em>“DOB”</em>, <em>“FiberPlacement”</em>, <em>“FiberSide”</em>, <em>“Sensor”</em>, <em>“Group”</em>, or other experimental variables. These fields will be carried forward into the final data structure and are useful for downstream analyses.</p>
<h4 id="create-and-save-the-file-key">Create and Save the File Key</h4>
<p>In the file key, each row should correspond to one fiber photometry session. For each session, the key must include at least the SubjectID, path to the raw data block, and path to where the extracted MATLAB structure should be saved. All file paths should be specified in the file key without the specific root directory portion of the path. <strong>For example</strong>, a file saved to a specific device at the path <em>"C:\Users\rmdon\Box\RawData\"</em> should be specified as  <em>"Box\RawData\"</em>. This facilitates analysis across multiple devices or cloud storage solutions without manual edits to the file key. Ensure the specified path ends in a forward slash.</p>
<p><strong>1.</strong> Create a csv file with the columns “SubjectID”, “BlockFolder”, “RawFolderPath”, and “ExtractedFolderPath”.</p>
<p><strong>2.</strong>: For each recording session, add a new row to the file:
-  In the <em>“SubjectID”</em> column, enter the corresponding “SubjectID” for the session. Ensure the File Key SubjectIDs match exactly with the IDs used in the Subject Key.</p>
<ul>
<li>
<p>In the <em>“BlockFolder”</em> column, enter the name of the block folder that contains the raw fiber photometry data for that session.</p>
</li>
<li>
<p>In the <em>“RawFolderPath”</em> column, specify the relative path to the parent directory that contains the block folder listed in the <em>“BlockFolder”</em> column. End the path with a forward slash (e.g., '\'). </p>
</li>
<li>
<p>In the <em>“ExtractedFolderPath”</em> column, enter the relative path to the parent directory where the extracted data structure should be saved. This should also end in a forward slash. The extracted data location should be separate from the location of the raw data blocks.  </p>
</li>
</ul>
<p><em>Note: All folder paths should be specified in the file key without the system-specific root directory portion of the path. This facilitates analysis across multiple devices or cloud storage solutions without manual edits to the file key. Ensure the specified path ends in a forward slash. For example, for a file where the extracted data structure should be saved to the path "C:\Users\rmdon\Box\ExtractedData\", the ExtractedFolderPath should be specified as "Box\ExtractedData\".</em></p>
<p><em>Note: For Mac users, all paths should be set using the convention of forward slashes in path directories.</em></p>
<p><strong>3.</strong> Optional but recommended: 
- Include session-specific variables as additional columns in the File Key. These may include information such as equipment used, recording power, session condition, drug treatments or injection volumes, body weight, or other relevant details unique to each recording session. Use field names without spaces or special characters to ensure compatibility with downstream analyses.</p>
<p><em>Note: The only field name that should be included in both the Subject Key and File Key is “SubjectID”. Ensure all additional fields have unique and non-duplicated names.</em></p>
<p><strong>For example:</strong>
<img alt="png" src="../../img/datapreparation_3_FileKeyExample.png" /></p>
<h2 id="prepare-matlab-for-analysis">Prepare MATLAB for analysis</h2>
<p>Prior to loading and processing fiber photometry data, the MATLAB environment is prepared by adding customized functions and data locations to the MATLAB path and creating helper variables to aid in accessing files. The subject key and file key are joined to create the overall <em>experimentkey</em>, which is used to locate, extract, and load fiber photometry data into MATLAB. Prior to beginning analysis, individual session data is extracted and saved as MATLAB data structures. This makes the process of loading data at the start of each analysis session significantly faster.</p>
<h3 id="prepare-the-matlab-environment">Prepare the MATLAB environment</h3>
<ul>
<li>
<p>Define the variable <em>rootdirectory</em> to store the system-specific portion of the file path. This typically corresponds to the user’s home directory or another consistent root location on the local machine (e.g., ‘C:\Users\rmdon\’).</p>
</li>
<li>
<p>Add the directories containing the subject key, file key, and PASTa function scripts to the MATLAB search path. This can be done manually through the MATLAB interface or in the main script using the <em>addpath</em> function.</p>
</li>
</ul>
<p><strong>Code example:</strong>
<img alt="png" src="../../img/datapreparation_4_preparepaths.png" /></p>
<h3 id="create-the-experiment-key">Create the Experiment Key</h3>
<p>Use the <em>createExperimentKey</em> function to create the <em>experimentkey</em> data structure. This function merges the individual subject information from the subject key with the session information from the file key.  It also appends the rootdirectory and folder names from the field <em>‘Folder’</em> to the <em>‘RawFolderPath’</em> and <em>‘ExtractedFolderPath’</em> fields. This creates the full paths for each session. The <em>experimentkey</em> is output as a MATLAB data structure. </p>
<p><strong>REQUIRED INPUTS:</strong></p>
<ul>
<li>
<p><strong>rootdirectory:</strong> The top level path unique to the user’s system to be appended to <em>RawFolderPath</em> and <em>ExtractedFolderPath</em></p>
</li>
<li>
<p><strong>subjectkeyname:</strong> The filename of the prepared Subject Key csv file (string; e.g., <em>‘subjectkey.csv’</em>). If no subject key is necessary (i.e., the experiment only involves one session per subject), set the <em>subjectkeyname</em> to empty (e.g., ‘’).</p>
</li>
<li>
<p><strong>filekeyname:</strong> The filename of the prepared File Key csv file (string). </p>
</li>
</ul>
<p><strong>OUTPUT:</strong></p>
<ul>
<li><strong>experimentkey</strong>: A data structure with each row in the file key matched to the subject key, with the full path from root directory to folder name in the <em>‘RawFolderPath’</em> and <em>‘ExtractedFolderPath’</em> fields.</li>
</ul>
<p><strong>Code example:</strong>
<img alt="png" src="../../img/datapreparation_5_createExperimentKey.png" /></p>
<h2 id="extract-fiber-photometry-data">Extract fiber photometry data</h2>
<p>Extract the fiber photometry data and save the resulting MATLAB structure for each session. One MATLAB structure will be created and saved per session. Saving data in this format facilitates efficient data loading across multiple sessions during downstream analysis. Pre-extracting and saving session-level structures significantly reduces processing time when accessing large datasets or performing batch analyses.</p>
<p>When the raw data is extracted, trimming will be applied by default. By default, this removes the first 5 seconds of the session to remove large fluctuations in output signal that occur when the hardware is turned on and off. The number of seconds trimmed can be adjusted by overriding the default.</p>
<p><img alt="png" src="../../img/datapreparation_6_trimexample.png" />
<strong>Trimming example.</strong> First 30 seconds of a fiber photometry recording session (Ventral Tegmental Area (VTA) dopamine activity, GCaMP6f), showing <strong>A)</strong> the raw signal from the 465nm channel and <strong>B)</strong> the raw background from the 405nm channel. Both panels illustrate the initial large artifact immediately following the start of the recording. To mitigate undesired effects on signal processing, PASTa by default extracts the data and trims the first 5 seconds of each session.</p>
<p>To extract fiber photometry data and save MATLAB structures for each session, two functions are available depending on the hardware used for data collection. </p>
<h3 id="option-1-synapse-tdt-format_1">Option 1: Synapse (TDT) Format</h3>
<p>For data collected with Synapse (Tucker Davis Technologies) software, use the <em>extractTDTdata</em> function to extract and save a MATLAB structure for each session.</p>
<p><strong>REQUIRED INPUTS:</strong></p>
<ul>
<li>
<p><strong>rawfolderpaths:</strong> A string array containing the full path from root directory to folder name for all sessions to be extracted (i.e., the paths contained in the experimentkey field <em>‘RawFolderPath’</em>). </p>
</li>
<li>
<p><strong>extractedfolderpaths:</strong> A string array containing the full path from root directory to folder name for all sessions to be extracted (e.g., the paths contained in the experimentkey field <em>‘ExtractedFolderPath’</em>). </p>
</li>
</ul>
<p><em>Note: the experimentkey can be used to prepare the string arrays of the rawfolderpaths and the extractedfolderpaths. For each array, subset the field in the experimentkey into a cell array and convert the values to strings. See the ‘Example Analysis’ scripts and the code below for an example.</em></p>
<ul>
<li>
<p><strong>sigstreamnames:</strong> A cell array containing all possible names of the signal stream in the raw data blocks (e.g., {‘465’, ‘x465’}).</p>
</li>
<li>
<p><strong>baqstreamnames:</strong> A cell array containing all possible names of the background or control stream in the raw data blocks (e.g., {‘405’, ‘x405’}).</p>
</li>
</ul>
<p><strong>OPTIONAL INPUTS:</strong></p>
<ul>
<li>
<p><strong>‘trim’:</strong> Specify the number of seconds to trim from the start of the session. By default, the first 5 seconds are trimmed from each stream (see trimming example figure above).</p>
</li>
<li>
<p><strong>‘skipexisting’:</strong> By default, the function will skip any sessions that already have an extracted MATLAB structure saved to the specified ExtractedFolderPath. To reprocess and overwrite existing structures, set <em>‘skipexisting’</em> to 0.</p>
</li>
</ul>
<p><strong>OUTPUT:</strong></p>
<ul>
<li>Individual MATLAB structures with extracted data for each session, saved to the location specified by the <em>extractedfolderpaths</em>. Each structure includes session date, session time, session length, the sampling rate (fs), fiber photometry signal and background streams (sig and baq), and any event epochs.</li>
</ul>
<p><em>Note: The names of the streams in the raw data blocks are set in the program Synapse. To determine what stream names were set, check the ‘StoresListing.txt’ file in the raw data block folders. Stream names may be stored with an ‘x’ in front of the numbers, and the ‘x’ may not appear in stores listing. As naming conventions may vary by fiber photometry rig, the inputs allow users to include multiple naming conventions. The function will identify which streams exist in the stored data and load the stores into the sig (signal) and baq (background or control) fields respectively.</em></p>
<p><strong>Code example:</strong>
<img alt="png" src="../../img/datapreparation_7_extractTDTdata.png" /></p>
<h3 id="option-2-csv-format_1">Option 2: CSV Format</h3>
<p>For data collected with other systems (e.g., Neurophotometrics, Doric), use the <em>extractCSVdata</em> function to extract and save a MATLAB structure for each session.</p>
<p><strong>REQUIRED INPUTS:</strong></p>
<ul>
<li>
<p><strong>rawfolderpaths:</strong> A string array containing the full path from root directory to folder name for all sessions to be extracted (i.e., the paths contained in the experimentkey field <em>‘RawFolderPath’</em>). </p>
</li>
<li>
<p><strong>extractedfolderpaths:</strong> A string array containing the full path from root directory to folder name for all sessions to be extracted (e.g., the paths contained in the experimentkey field <em>‘ExtractedFolderPath’</em>). </p>
</li>
</ul>
<p><em>Note: the experimentkey can be used to prepare the string arrays of the rawfolderpaths and the extractedfolderpaths. For each array, subset the field in the experimentkey into a cell array and convert the values to strings. See the ‘Example Analysis’ scripts and the code below for an example.</em></p>
<ul>
<li>
<p><strong>sigstreamname:</strong> A string containing the name of csv file of the signal stream in the raw data block folders (e.g., ‘465’).</p>
</li>
<li>
<p><strong>baqstreamname:</strong> A string containing the name of csv file of the background or control stream stream in the raw data block folders  (e.g., ‘405’).</p>
</li>
</ul>
<p><strong>OPTIONAL INPUTS:</strong></p>
<ul>
<li>
<p><strong>'loadepocs’:</strong> Set to 1 to load files containing event epochs.</p>
</li>
<li>
<p><strong>‘epocsnames’:</strong> A cell array containing all names of the csv files in the raw data block folders containing event epochs to be extracted and added to the data structure (e.g., {‘injt’, ‘strt’}).</p>
</li>
<li>
<p><strong>‘trim’:</strong> Specify the number of seconds to trim from the start of the session. By default, the first 5 seconds are trimmed from each stream (see trimming example figure above).</p>
</li>
<li>
<p><strong>‘skipexisting’:</strong> By default, the function will skip any sessions that already have an extracted MATLAB structure saved to the specified ExtractedFolderPath. To reprocess and overwrite existing structures, set <em>‘skipexisting’</em> to 0.</p>
</li>
</ul>
<p><strong>OUTPUT:</strong></p>
<ul>
<li>Individual MATLAB structures with extracted data for each session, saved to the location specified by the <em>extractedfolderpaths</em>. Each structure includes session date, session time, session length, the sampling rate (fs), fiber photometry signal and background streams (sig and baq), and any event epochs.</li>
</ul>
<p><strong>Code example:</strong>
<img alt="png" src="../../img/datapreparation_8_extractCSVdata.png" /></p>
<h2 id="load-fiber-photometry-data">Load Fiber Photometry Data</h2>
<p>To facilitate the processing of fiber photometry data and transient event detection, the PASTa protocol utilizes MATLAB data structures to organize the inputs and outputs to and from PASTa functions. The prepared data structure should contain each fiber photometry recording session as a row, with all subject and session specific metadata in addition to fiber photometry data streams, sampling rate, and event epochs.</p>
<h3 id="load-data-into-a-matlab-structure">Load data into a MATLAB structure</h3>
<p>Use the <em>loadKeydata</em> function to load the extracted fiber photometry data for all sessions in the <em>experimentkey</em>. This function matches each session in the experiment key to its corresponding extracted MATLAB structure and appends fiber photometry data fields. Regardless of hardware set up and which data extraction function is used, all extracted files can be loaded with the function <em>loadKeydata</em>.</p>
<p><strong>REQUIRED INPUTS:</strong></p>
<ul>
<li><strong>experimentkey:</strong> The <em>experimentkey</em> object created by the <em>createExperimentKey</em> function.</li>
</ul>
<p><strong>Output:</strong></p>
<ul>
<li><strong>data:</strong> The combined data structure containing all fields in the experiment key appended with the extracted fiber photometry data for each session. All subject and session specific metadata are included alongside the fiber photometry data for streamlined analysis.</li>
</ul>
<p><em>Note: If desired, users can create and use their own pipeline to organize and load fiber photometry data into MATLAB. To be compatible with PASTa functions, the data preparation process should result in a MATLAB data structure with each fiber photometry session as a row with fields containing at least a SubjectID variable, the photometry signal stream (e.g., 465nm stream), and the photometry control or background stream (e.g., 405nm stream).</em></p>
<p><strong>Code example:</strong>
<img alt="png" src="../../img/datapreparation_9_cropFPdata.png" /></p>
<h3 id="optional-crop-fiber-photometry-data">Optional: Crop fiber photometry data</h3>
<p>In cases where fiber photometry recordings begin or end outside the experimentally relevant period – for example, when hardware is manually triggered before or after the behavioral task begins or ends – users may wish to crop the data streams to remove the beginning and end of each session. Additionally, users may wish to exclude the initial portion of the recording session (e.g., the first few minutes), where photobleaching is typically more pronounced and nonlinear before signal stabilization.</p>
<p><img alt="png" src="../../img/datapreparation_9_cropexample.png" />
<strong>Crop data example:</strong> Fiber photometry (VTA dopamine activity, GCaMP6f) raw <strong>A)</strong> signal (465nm) and <strong>B)</strong> background (405nm) data streams each fit with an exponential decay function (red). Both streams show a steeper decay slope in the first two minutes, reflecting an initially faster rate of photobleaching that stabilizes over time. To account for this, the PASTa protocol recommends cropping the data streams to exclude the first two minutes of each session prior to further analysis.</p>
<p>If cropping is desired, users must first prepare the start and end indexes of the range of the data streams to be included. Any samples outside the start and stop indexes will be remove. If event epochs are included in the analysis, users should specify an optional input to adjust the epochs by the crop start index to maintain spatial aligned with data streams.</p>
<p><strong>1.</strong> Prepare session start and end indexes. Add fields to the data structure specifying the desired session start and end sample indexes for each session. Ensure these values are integers. </p>
<p><em>Note: Start and end points can typically be calculated using time and sampling rate or can be anchored to a known event epoch such as the start of a behavioral paradigm. Examples of start and end index calculation are included in the Example Analysis files.</em></p>
<p><strong>Code example:</strong>
<img alt="png" src="../../img/datapreparation_10_preparecropindices.png" /></p>
<p><strong>2.</strong> Use the <em>cropFPdata</em> function to crop fiber photometry streams based on user-defined session start and end sample indexes. This function also adjusts event epochs to maintain correct temporal alignment. </p>
<p><strong>REQUIRED INPUTS:</strong></p>
<ul>
<li><strong>data:</strong> Data structure created by the <em>LoadKeyData</em> function. Each session should be a separate row. The data structure must containing at least the fields specified in the additional inputs.</li>
</ul>
<p><strong>REQUIRED INPUTS:</strong></p>
<ul>
<li>
<p><strong>data:</strong> The full data structure containing all session data.</p>
</li>
<li>
<p><strong>cropstartfieldname:</strong> The name (string) of the field in the data structure containing the prepared start indexes for cropping (e.g., ‘sessionstart’).</p>
</li>
<li>
<p><strong>cropendfieldname:</strong> A string containing the name of the field with the locations of the session end indices. Everything after the end index will be cropped.</p>
</li>
<li>
<p><strong>streamfieldnames:</strong> A cell array containing the names of the streams to be cropped. Typically, this includes the fields containing the signal and background streams (e.g., {‘sig’, ‘baq’}).</p>
</li>
</ul>
<p><strong>OPTIONAL INPUTS:</strong></p>
<ul>
<li><strong>'epocsfieldnames':</strong> A cell array containing the names of all event epoch fields that should be adjusted in accordance with the cropping. Epoch fields should contain timestamps in sample number for each event. Each timestamp will be offset by the number of samples removed at the start of the session. Any number of event fields can be adjusted depending on the needs of the experimental paradigm (e.g., {‘strt’, ‘injt’}).</li>
</ul>
<p><strong>OUTPUT:</strong></p>
<ul>
<li><strong>data:</strong> The data structure with the specified fields cropped and any input epochs adjusted to maintain alignment.</li>
</ul>
<p><em>Note: The cropFPdata function directly modifies the fields in the input MATLAB data structure by overwriting the specific fiber photometry streams and any event epochs selected for adjusted. To maintain data integrity and traceability, consider loading the original fiber photometry data into a separate structure (e.g., rawdata) and saving the cropped output to a new structure (e.g., data). This approach helps preserve the unaltered data and prevent accidental double cropping during analysis.</em></p>
<p><strong>Code example of cropping:</strong>
<img alt="png" src="../../img/datapreparation_11_cropFPdata.png" /></p>
<p>After data preparation is complete, continue to <a href="https://rdonka.github.io/PASTaUserGuide/userguide/signalprocessing/">Signal Processing</a>.</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
